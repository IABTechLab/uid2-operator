name: Run operator E2E tests
run-name: ${{ format('Run {0} operator E2E tests', inputs.operator_type) }} by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      operator_type:
        type: choice
        description: The operator type [public, gcp, azure, aws]
        options:
        - public
        - gcp
        - azure
        - aws
      operator_image_version:
        description: The pipeline will run the E2E test with this operator image version
        type: string
        default: latest
      core_image_version:
        description: The pipeline will run the E2E test with this core image version
        type: string
        default: latest
      optout_image_version:
        description: The pipeline will run the E2E test with this optout image version
        type: string
        default: latest
      e2e_image_version:
        description: The pipeline will run the E2E test with this e2e image version
        type: string
        default: latest
      core_branch:
        description: The branch of uid2-core to test on
        type: string
        default: main
      optout_branch:
        description: The branch of uid2-optout to test on
        type: string
        default: main
      admin_branch:
        description: The branch of uid2-admin to test on
        type: string
        default: main
      operator_branch:
        description: The branch of uid2-operator to test on
        type: string
        default: main
      aws_region:
        description: The AWS region [us-east-1, us-west-1, ca-central-1]
        type: string
      aws_ami:
        description: The AWS AMI ID
        type: string
      aws_pcr0:
        description: The AWS PCR0
        type: string

  workflow_call:
    inputs:
      operator_type:
        description: The operator type [public, gcp, azure, aws]
        type: string
        default: public
      operator_image_version:
        description: The pipeline will run the E2E test with this operator image version
        type: string
        default: latest
      core_image_version:
        description: The pipeline will run the E2E test with this core image version
        type: string
        default: latest
      optout_image_version:
        description: The pipeline will run the E2E test with this optout image version
        type: string
        default: latest
      e2e_image_version:
        description: The pipeline will run the E2E test with this e2e image version
        type: string
        default: latest
      core_branch:
        description: The branch of uid2-core to test on
        type: string
        default: main
      optout_branch:
        description: The branch of uid2-optout to test on
        type: string
        default: main
      admin_branch:
        description: The branch of uid2-admin to test on
        type: string
        default: main
      operator_branch:
        description: The branch of uid2-operator to test on
        type: string
        default: main
      aws_region:
        description: The AWS region [us-east-1, us-west-1, ca-central-1]
        type: string
        default: us-east-1
      aws_ami:
        description: The AWS AMI ID
        type: string
        default: ''
      aws_pcr0:
        description: The AWS PCR0
        type: string
        default: ''

jobs:
  e2e-test:
    name: E2E Test
    uses: IABTechLab/uid2-shared-actions/.github/workflows/shared-run-e2e-tests.yaml@gdm-UID2-2341-aws-test-pipeline
    with:
      operator_type: ${{ inputs.operator_type }}
      operator_image_version: ${{ inputs.operator_image_version }}
      core_image_version: ${{ inputs.core_image_version }}
      optout_image_version: ${{ inputs.optout_image_version }}
      e2e_image_version: ${{ inputs.e2e_image_version }}
      core_branch: ${{ inputs.core_branch }}
      optout_branch: ${{ inputs.optout_branch }}
      admin_branch: ${{ inputs.admin_branch }}
      operator_branch: ${{ github.ref }}
      gcp_workload_identity_provider_id: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER_ID }}
      gcp_service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}
      gcp_project: ${{ vars.GCP_PROJECT }}
      aws_region: ${{ inputs.aws_region }}
      aws_ami: ${{ inputs.aws_ami }}
      aws_pcr0: ${{ inputs.aws_pcr0 }}
    secrets: inherit
